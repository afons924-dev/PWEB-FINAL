@page "/products"
@inject ApplicationDbContext DbContext

<h3>Product Management</h3>

<div class="row mb-3">
    <div class="col-md-4">
        <input class="form-control" @bind="searchTerm" placeholder="Search title..." />
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary" @onclick="Search">Search</button>
    </div>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Title</th>
            <th>Base Price</th>
            <th>Final Price</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var product in products)
        {
            <tr>
                <td>@product.Title</td>
                <td>@product.BasePrice</td>
                <td>@product.FinalPrice</td>
                <td>@(product.IsActive ? "Active" : "Pending")</td>
                <td>
                    <button class="btn btn-primary" @onclick="() => EditProduct(product)">Edit</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="d-flex justify-content-between">
    <button class="btn btn-secondary" @onclick="PrevPage" disabled="@(currentPage == 1)">Previous</button>
    <span>Page @currentPage</span>
    <button class="btn btn-secondary" @onclick="NextPage" disabled="@(products.Count < pageSize)">Next</button>
</div>

@if (selectedProduct != null)
{
    <div class="card mt-4">
        <div class="card-header">Edit Product</div>
        <div class="card-body">
            <EditForm Model="@selectedProduct" OnValidSubmit="SaveProduct">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label>Title</label>
                    <InputText @bind-Value="selectedProduct.Title" class="form-control" />
                </div>
                <div class="mb-3">
                    <label>Base Price</label>
                    <InputNumber @bind-Value="selectedProduct.BasePrice" class="form-control" />
                </div>
                <div class="mb-3">
                    <label>Markup Percentage (e.g. 20 for 20%)</label>
                    <input type="number" @bind="MarkupPercentage" class="form-control" />
                </div>

                <div class="mb-3">
                    <label>Final Price (Auto-calc)</label>
                    <input value="@CalculateFinalPrice()" class="form-control" disabled />
                </div>

                <div class="mb-3">
                    <label>Stock Quantity</label>
                    <InputNumber @bind-Value="selectedProduct.StockQuantity" class="form-control" />
                </div>

                <div class="mb-3 form-check">
                    <InputCheckbox @bind-Value="selectedProduct.IsActive" class="form-check-input" />
                    <label class="form-check-label">Is Active? (Visible in Store)</label>
                </div>

                <button type="submit" class="btn btn-success">Save & Publish</button>
                <button type="button" class="btn btn-secondary" @onclick="() => selectedProduct = null">Cancel</button>
            </EditForm>
        </div>
    </div>
}

@code {
    List<Product> products = new();
    Product? selectedProduct;
    decimal MarkupPercentage = 0;
    string searchTerm = "";
    int currentPage = 1;
    int pageSize = 10;

    protected override void OnInitialized()
    {
        LoadProducts();
    }

    void LoadProducts()
    {
        var query = DbContext.Products.AsQueryable();
        if(!string.IsNullOrEmpty(searchTerm))
             query = query.Where(p => p.Title.Contains(searchTerm));

        products = query.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();
    }

    void Search() { currentPage = 1; LoadProducts(); }
    void PrevPage() { if(currentPage > 1) { currentPage--; LoadProducts(); } }
    void NextPage() { currentPage++; LoadProducts(); }

    void EditProduct(Product product)
    {
        selectedProduct = product;
        // Estimate markup from current prices if possible, else 0
        if(product.BasePrice > 0)
            MarkupPercentage = Math.Round(((product.FinalPrice - product.BasePrice) / product.BasePrice) * 100, 0);
    }

    decimal CalculateFinalPrice()
    {
        if (selectedProduct == null) return 0;
        return selectedProduct.BasePrice + (selectedProduct.BasePrice * MarkupPercentage / 100);
    }

    void SaveProduct()
    {
        selectedProduct.FinalPrice = CalculateFinalPrice();
        DbContext.Update(selectedProduct);
        DbContext.SaveChanges();
        selectedProduct = null;
        LoadProducts();
    }
}
