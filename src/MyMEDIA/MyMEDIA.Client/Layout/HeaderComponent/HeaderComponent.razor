@using MyMEDIA.Client.Services
@using MyMEDIA.Client.Services.Interfaces
@using MyMEDIA.Shared.DTO
@inject IUserSessionService UserSessionService
@inject NavigationManager NavigationManager
@inject IApiServices apiServices
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Http

<div class="header-container" style="background-color: #f8f9fa; padding: 10px; border-bottom: 1px solid #ddd;">

    <div class="header-main" style="display: flex; justify-content: space-between; align-items: center;">

        <div>
            <span class="logo-span" style="font-size: 1.5rem; font-weight: bold;">
                <a class="logo-span" href="/" style="text-decoration: none; color: #333;">@AppConfig.tituloHomePage</a>
            </span>
        </div>

        <div class="nav-main">
            <a href="cart" class="btn btn-outline-primary">Cart</a>
        </div>

        <div>
            @if (!estaAutenticado)
            {
                <a href="modalogin" class="btn btn-primary ms-2">Login</a>
                <a href="registeruser" class="btn btn-secondary ms-2">Register</a>
            }
            else
            {
                <a href="my-orders" class="btn btn-info ms-2">Orders</a>
                <a href="profile" class="btn btn-light ms-2">Profile</a>
                <button class="btn btn-danger ms-2" @onclick="Logout">Logout</button>
            }
        </div>

    </div>

</div>

@code {

    private bool estaAutenticado;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        estaAutenticado = await utilizadorAutenticado();

        if (HttpContext != null && HttpContext.User.Identity != null)
        {
            estaAutenticado = HttpContext.User.Identity.IsAuthenticated;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var token = await UserSessionService.GetToken();

        if (token != null)
        {
            var resultado = await apiServices.VerificarEstadoUtilizador(token.UtilizadorId!);

            if (resultado.HasError)
            {
                await UserSessionService.Logout();
                token = null;
            }
        }

        var estadoAtual = token != null;

        if (estadoAtual != estaAutenticado)
        {
            estaAutenticado = estadoAtual;
            StateHasChanged();
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task<bool> utilizadorAutenticado()
    {
        bool estadoAutenticacaoServiceSessao = await UserSessionService.IsUserLoggedIn();
        return estaAutenticado || estadoAutenticacaoServiceSessao;
    }

    private async Task Logout()
    {
        await UserSessionService.Logout();
        estaAutenticado = false;
        NavigationManager.NavigateTo("/", forceLoad: true);
    }
}
